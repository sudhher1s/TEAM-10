<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Medical Coding Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0e27;
      --panel: #0f1420;
      --card: #141b2d;
      --text: #f1f5f9;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --accent-2: #a78bfa;
      --success: #10b981;
      --warn: #f59e0b;
      --danger: #ef4444;
      --border: #1e293b;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .6; } }
    @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }
    @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-8px); } }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, var(--bg), #0f1420 50%, var(--bg)); color: var(--text); min-height: 100vh; overflow-x: hidden; }
    
    header { padding: 24px 32px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 16px; backdrop-filter: blur(20px); background: rgba(10, 14, 39, 0.85); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,.3); }
    .logo { width: 48px; height: 48px; border-radius: 14px; background: radial-gradient(circle at 30% 30%, var(--accent), var(--accent-2)); box-shadow: 0 10px 30px rgba(34, 211, 238, 0.35); animation: float 3s ease-in-out infinite; }
    .header-content { flex: 1; }
    .title { font-weight: 700; letter-spacing: 0.4px; font-size: 22px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .subtitle { color: var(--muted); font-size: 13px; margin-top: 2px; font-weight: 500; }
    .status-badge { position: absolute; right: 32px; top: 50%; transform: translateY(-50%); padding: 10px 16px; background: rgba(16, 185, 129, .15); border: 1px solid var(--success); color: var(--success); border-radius: 999px; font-size: 12px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .status-badge::before { content: ''; width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 8px var(--success); }
    
    .container { max-width: 1400px; margin: 28px auto; padding: 0 24px; animation: fadeIn 0.7s ease; }
    .tabs { display: flex; gap: 10px; margin-bottom: 24px; flex-wrap: wrap; border-bottom: 2px solid var(--border); padding-bottom: 0; }
    .tab { padding: 14px 22px; background: transparent; color: var(--muted); cursor: pointer; border: none; border-bottom: 3px solid transparent; transition: all .3s cubic-bezier(0.4, 0, 0.2, 1); font-weight: 600; font-size: 14px; margin-bottom: -2px; }
    .tab:hover { color: var(--accent); border-bottom-color: rgba(34, 211, 238, .5); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    
    .panels { background: var(--panel); border-radius: 20px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 24px 70px rgba(0, 0, 0, .5); }
    .panel { display: none; padding: 28px; animation: fadeIn 0.5s ease; }
    .panel.active { display: block; }
    
    .grid-2 { display: grid; grid-template-columns: 1.5fr 1.2fr; gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
    .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: 1fr 1fr; } }
    @media (max-width: 768px) { .grid-2-col { grid-template-columns: 1fr; } .grid-3 { grid-template-columns: 1fr; } }
    
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; transition: all .3s; display: flex; flex-direction: column; }
    .card:hover { border-color: rgba(34, 211, 238, .4); box-shadow: 0 10px 30px rgba(34, 211, 238, .12); transform: translateY(-2px); }
    .card h3 { margin: 0 0 14px; font-size: 16px; font-weight: 700; color: var(--accent); letter-spacing: 0.3px; display: flex; align-items: center; gap: 8px; }
    
    textarea, input[type="text"], input[type="number"] { width: 100%; background: rgba(10, 14, 39, .5); color: var(--text); border: 2px solid var(--border); border-radius: 12px; padding: 12px 14px; font-size: 14px; outline: none; transition: all .3s; font-family: inherit; }
    textarea:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(34, 211, 238, .12); background: rgba(10, 14, 39, .7); }
    textarea { min-height: 140px; resize: vertical; line-height: 1.6; }
    
    button { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: var(--bg); font-weight: 700; border: none; border-radius: 12px; padding: 12px 24px; cursor: pointer; box-shadow: 0 10px 24px rgba(167, 139, 250, .35); transition: all .3s; font-size: 14px; letter-spacing: 0.3px; display: flex; align-items: center; gap: 8px; }
    button:hover { transform: translateY(-2px); box-shadow: 0 14px 32px rgba(167, 139, 250, .45); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: .6; cursor: not-allowed; transform: none; }
    
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
    .pill { display: inline-flex; align-items: center; gap: 8px; font-size: 12px; padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border); background: rgba(10, 14, 39, .6); color: var(--muted); white-space: nowrap; font-weight: 500; }
    .pill strong { color: var(--text); font-weight: 600; }
    .pill input { width: 60px; padding: 4px 8px; font-size: 12px; border-radius: 6px; }
    
    .mono { font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace; font-size: 13px; line-height: 1.8; white-space: pre-wrap; word-wrap: break-word; }
    
    .list { display: flex; flex-direction: column; gap: 12px; max-height: 550px; overflow-y: auto; flex: 1; }
    .list::-webkit-scrollbar { width: 7px; }
    .list::-webkit-scrollbar-track { background: rgba(30, 41, 59, .3); border-radius: 999px; }
    .list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 999px; transition: background .2s; }
    .list::-webkit-scrollbar-thumb:hover { background: var(--muted); }
    
    .item { border: 1px solid var(--border); border-radius: 14px; padding: 16px; background: linear-gradient(135deg, rgba(20, 27, 45, .7), rgba(15, 20, 32, .7)); transition: all .3s; animation: slideIn 0.4s ease; backdrop-filter: blur(8px); }
    .item:hover { border-color: rgba(34, 211, 238, .4); background: linear-gradient(135deg, rgba(20, 27, 45, .95), rgba(15, 20, 32, .95)); transform: translateX(3px); box-shadow: 0 8px 20px rgba(34, 211, 238, .15); }
    .item .code { color: var(--accent); font-weight: 700; font-size: 15px; letter-spacing: 0.4px; }
    .item .title { color: var(--text); margin-top: 5px; font-weight: 600; font-size: 14px; line-height: 1.4; }
    .item .desc { color: var(--muted); margin-top: 8px; font-size: 12px; line-height: 1.6; }
    .item .meta { margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(30, 41, 59, .5); display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    
    .badge { font-size: 10px; font-weight: 700; color: var(--bg); background: var(--success); border-radius: 999px; padding: 5px 10px; display: inline-block; text-transform: uppercase; letter-spacing: 0.4px; }
    .badge.warn { background: var(--warn); }
    .badge.info { background: var(--accent); }
    
    .loading { animation: pulse 1.5s ease-in-out infinite; }
    .shimmer { background: linear-gradient(90deg, transparent, rgba(34, 211, 238, .1), transparent); background-size: 2000px 100%; animation: shimmer 2s linear infinite; }
    
    .rec-panel { margin-top: 16px; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, .08), rgba(34, 211, 238, .08)); border-left: 4px solid var(--success); border-radius: 12px; }
    .rec-panel h4 { color: var(--success); font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-weight: 700; }
    .rec-panel h4::before { content: '‚úì'; font-size: 16px; }
    .rec-panel .item-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 13px; }
    
    .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 12px; }
    .chat-message { margin-bottom: 12px; padding: 12px; border-radius: 12px; max-width: 85%; animation: slideIn 0.3s ease; }
    .chat-message.user { background: rgba(34, 211, 238, .15); margin-left: auto; border: 1px solid rgba(34, 211, 238, .3); }
    .chat-message.bot { background: rgba(20, 27, 45, .7); border: 1px solid var(--border); }
    .chat-input-row { display: flex; gap: 10px; }
    .chat-input-row input { flex: 1; }
  </style>
</head>
<body>
  <header>
    <div class="logo"></div>
    <div class="header-content">
      <div class="title">Medical Coding Assistant</div>
      <div class="subtitle">Evidence-Based ICD-10 Code Recommendations ‚Ä¢ Real-Time Analysis</div>
    </div>
    <div class="status-badge">System Online</div>
  </header>

  <div class="container">
    <div class="tabs">
      <div class="tab active" data-tab="prescription">üìã Prescription Analysis</div>
      <div class="tab" data-tab="chatbot">ü§ñ ChatBot</div>
      <div class="tab" data-tab="pipeline">‚öôÔ∏è Pipeline Status</div>
    </div>

    <div class="panels">
      <!-- TAB 1: PRESCRIPTION ANALYSIS -->
      <div class="panel active" id="panel-prescription">
        <div class="grid-2">
          <div class="card">
            <h3>üìù Clinical Note Input</h3>
            <textarea id="prescriptionText" placeholder="Enter patient clinical note, diagnosis, symptoms, or medical condition..."></textarea>
            <div class="row">
              <span class="pill">Provider:
                <select id="providerSel" style="background:transparent; color:var(--text); border:none; outline:none;">
                  <option value="google" selected>Google Gemini</option>
                  <option value="openai">OpenAI</option>
                  <option value="mock">Mock</option>
                </select>
              </span>
              <span class="pill">Model: <input id="modelInput" type="text" value="gemini-2.5-flash" style="width:140px;" /></span>
              <span class="pill">Retrieve K: <input id="retrieveK" type="number" value="100" min="10" max="500"></span>
              <span class="pill">Rerank K: <input id="rerankK" type="number" value="10" min="3" max="50"></span>
              <button id="btnCode">üîç Analyze</button>
            </div>
          </div>
          
          <div class="card">
            <h3>üí° Recommended Codes</h3>
            <div id="codesOut" class="list">
              <div class="item" style="opacity:.5;">
                <div class="code">Enter clinical note</div>
                <div class="desc">System will retrieve and rank ICD-10 codes based on clinical evidence.</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
          <h3>üß† Clinical Reasoning & Evidence</h3>
          <div id="llmOut" class="mono" style="color:var(--muted); line-height:1.8;">
            Waiting for input...
          </div>
        </div>
      </div>

      <!-- TAB 2: CHATBOT -->
      <div class="panel" id="panel-chatbot">
        <div class="grid-2-col">
          <div class="card">
            <h3>üí¨ Medical Coding ChatBot</h3>
            <div class="chat-messages" id="chatLog">
              <div class="chat-message bot">
                <strong style="color:var(--accent);">Assistant</strong><br/>
                <span style="color:var(--muted); font-size:13px;">Hello! I'm your medical coding assistant. Ask me about ICD-10 codes, clinical guidelines, code selection rationale, or submit clinical notes for analysis.</span>
              </div>
            </div>
            <div class="row" style="margin-top:10px;">
              <span class="pill">Provider:
                <select id="chatProvider" style="background:transparent; color:var(--text); border:none; outline:none;">
                  <option value="google" selected>Google Gemini</option>
                  <option value="openai">OpenAI</option>
                  <option value="mock">Mock</option>
                </select>
              </span>
              <span class="pill">Model: <input id="chatModel" type="text" value="gemini-2.5-flash" style="width:140px;" /></span>
            </div>
            <div class="chat-input-row" style="margin-top:10px;">
              <input type="text" id="chatInput" placeholder="Ask about codes, guidelines, or submit clinical notes..." />
              <button id="btnChat">Send</button>
            </div>
          </div>
          
          <div class="card">
            <h3>üìä Response & Evidence</h3>
            <div id="chatOut" class="mono" style="color:var(--muted); font-size:12px; line-height:1.7;">
              Bot responses will appear here...
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 3: PIPELINE STATUS -->
      <div class="panel" id="panel-pipeline">
        <div class="grid-3">
          <div class="card">
            <h3>üìö Module 1: KB Builder</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Builds unified knowledge base from ICD-10, CPT, SNOMED codes<br/>
              <span style="font-size:11px; color:var(--muted);">Input: Raw medical coding data</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üî¢ Module 2: Embeddings</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Generates 384-dim semantic embeddings<br/>
              <span style="font-size:11px; color:var(--muted);">Model: all-MiniLM-L6-v2</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üéØ Module 3: FAISS Index</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Fast vector similarity search (IVF)<br/>
              <span style="font-size:11px; color:var(--muted);">71K+ codes indexed</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üîç Module 4: Query Encoder</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Encodes queries & searches index<br/>
              <span style="font-size:11px; color:var(--muted);">Retrieves top-k candidates</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üìä Module 5: Reranker</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Cross-encoder re-ranks candidates<br/>
              <span style="font-size:11px; color:var(--muted);">Model: ms-marco-MiniLM-L-6-v2</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üß¨ Module 6: Evidence</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Extracts KB context & evidence<br/>
              <span style="font-size:11px; color:var(--muted);">Descriptions, aliases, categories</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üõ°Ô∏è Module 7: Guardrails</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Validates compliance & policies<br/>
              <span style="font-size:11px; color:var(--muted);">Flags violations</span>
            </div>
          </div>
          
          <div class="card">
            <h3>ü§ñ Module 8: LLM Grounder</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Generates clinical reasoning<br/>
              <span style="font-size:11px; color:var(--muted);">Provider: Google/OpenAI/Mock</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üîó Module 9: Orchestrator</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              Chains all modules end-to-end<br/>
              <span style="font-size:11px; color:var(--muted);">Entrypoint for pipeline</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üöÄ Module 10: API</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì Active</strong><br/>
              FastAPI server & static UI<br/>
              <span style="font-size:11px; color:var(--muted);">Port: 8001</span>
            </div>
          </div>
          
          <div class="card">
            <h3>üì° System Status</h3>
            <div style="font-size:12px; color:var(--muted); line-height:1.8;">
              <strong style="color:var(--success);">‚úì All Modules Running</strong><br/>
              Full pipeline integrated & operational<br/>
              <span style="font-size:11px; color:var(--muted);">Ready for production use</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const apiBase = window.location.origin;

    // Tab switching
    document.querySelectorAll('.tab').forEach(t => {
      t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const tabName = t.dataset.tab;
        document.getElementById(`panel-${tabName}`).classList.add('active');
      });
    });

    // Prescription Analysis
    const btnCode = document.getElementById('btnCode');
    const prescriptionText = document.getElementById('prescriptionText');
    const retrieveK = document.getElementById('retrieveK');
    const rerankK = document.getElementById('rerankK');
    const providerSel = document.getElementById('providerSel');
    const modelInput = document.getElementById('modelInput');
    const codesOut = document.getElementById('codesOut');
    const llmOut = document.getElementById('llmOut');

    btnCode.addEventListener('click', async () => {
      if (!prescriptionText.value.trim()) {
        codesOut.innerHTML = '<div class="item"><span class="badge warn">Warning</span><div class="desc">Please enter a clinical note first</div></div>';
        return;
      }

      btnCode.disabled = true;
      btnCode.innerHTML = '‚è≥ Processing...';
      codesOut.innerHTML = '<div class="item loading shimmer"><div class="code">Analyzing...</div><div class="desc">Running: Retrieve ‚Üí Rerank ‚Üí Evidence ‚Üí Guardrails ‚Üí Ground</div></div>';
      llmOut.innerHTML = '<div class="loading">Generating clinical reasoning...</div>';

      try {
        const resp = await fetch(`${apiBase}/code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: prescriptionText.value,
            provider: providerSel.value || 'google',
            model: modelInput.value.trim() || 'gemini-2.5-flash',
            retrieve_k: parseInt(retrieveK.value || '100', 10),
            rerank_k: parseInt(rerankK.value || '10', 10),
            kb_path: 'c:/MY PROJECTS/GEN AI/working_modules/module_1_data_kb/output/kb.json',
            index_path: 'c:/MY PROJECTS/GEN AI/working_modules/output/faiss.index',
            metadata_path: 'c:/MY PROJECTS/GEN AI/working_modules/output/item_metadata.json'
          })
        });

        if (!resp.ok) throw new Error(`API error ${resp.status}`);
        const data = await resp.json();

        // Display grounded recommendations (primary)
        codesOut.innerHTML = '';
        const groundedCodes = Array.isArray(data.grounded?.codes) ? data.grounded.codes : [];
        const confidence = data.grounded?.confidence || 0;
        const modelUsed = data.grounded?.model || 'n/a';
        const elapsed = data.grounded?.elapsed_ms || 0;
        const warnings = (data.guardrails?.violations || []).map(v => `<li>${v.message || v.severity}</li>`).join('');
        const evidenceItems = (data.evidence?.items) || [];

        if (groundedCodes.length === 0) {
          codesOut.innerHTML = '<div class="item"><span class="badge warn">No Codes</span><div class="desc">LLM did not return specific codes. Check explanation.</div></div>';
        } else {
          groundedCodes.forEach(code => {
            const ev = evidenceItems.find(e => e.code === code) || {};
            let relevance = Math.round((ev.relevance_score || 0) * 100);
            if (isNaN(relevance)) relevance = 0;
            if (relevance > 100) relevance = 100;
            if (relevance < 0) relevance = 0;
            const description = ev.description || 'No description';
            const aliases = ev.aliases && ev.aliases.length ? ev.aliases.join(', ') : '';
            const category = ev.category || 'General';
            let badgeColor = 'linear-gradient(135deg, var(--accent), var(--accent-2))';
            if (relevance >= 75) badgeColor = 'linear-gradient(135deg, var(--success), var(--accent))';
            else if (relevance < 50) badgeColor = 'linear-gradient(135deg, var(--warn), var(--accent))';

            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
                <div class="code">${code}</div>
                <span class="badge" style="background:${badgeColor};">${relevance || 0}% match</span>
              </div>
              <div class="title">${ev.title || 'Code from LLM recommendation'}</div>
              <div class="desc"><strong>üìù</strong> ${description}</div>
              ${aliases ? `<div class="desc" style="margin-top:4px;"><strong>üîó</strong> ${aliases}</div>` : ''}
              <div class="meta">
                <span class="pill"><strong>Category:</strong> ${category}</span>
                <span class="pill"><strong>Score:</strong> ${(ev.relevance_score || 0).toFixed(3)}</span>
              </div>
            `;
            codesOut.appendChild(div);
          });
        }

        // Display LLM explanation and metadata
        const explanation = data.grounded?.explanation || 'No reasoning available';
        llmOut.innerHTML = `
          <div class="rec-panel">
            <h4>Top Code Recommendations</h4>
            <div class="item-row"><strong>Codes:</strong> <span style="color:var(--accent); font-weight:700;">${groundedCodes.join(', ') || 'None'}</span></div>
            <div class="item-row"><strong>Confidence:</strong> <span style="color:var(--success); font-weight:700;">${confidence}%</span></div>
            <div class="item-row"><strong>Model:</strong> <span>${modelUsed}</span> <span style="color:var(--muted);">(${elapsed.toFixed ? elapsed.toFixed(0) : elapsed} ms)</span></div>
          </div>
          <div style="margin-top:16px; line-height:1.8; color:var(--text);">
            <strong style="color:var(--accent);">Clinical Reasoning:</strong><br/><br/>
            ${explanation}
          </div>
          ${warnings ? `<div style="margin-top:16px; padding:12px; background:rgba(245, 158, 11, .1); border-left:3px solid var(--warn); border-radius:8px; font-size:12px;"><strong style="color:var(--warn);">‚ö†Ô∏è Compliance:</strong><ul style="margin-top:6px; padding-left:16px;">${warnings}</ul></div>` : ''}
        `;

      } catch (err) {
        codesOut.innerHTML = `<div class="item"><span class="badge warn">Error</span><div class="desc">${err.message}</div></div>`;
        llmOut.innerHTML = `<div style="color:var(--danger);">‚ö†Ô∏è Error. Please try again.</div>`;
      } finally {
        btnCode.disabled = false;
        btnCode.innerHTML = 'üîç Analyze';
      }
    });

    // ChatBot
    const btnChat = document.getElementById('btnChat');
    const chatInput = document.getElementById('chatInput');
    const chatLog = document.getElementById('chatLog');
    const chatOut = document.getElementById('chatOut');
    const chatProvider = document.getElementById('chatProvider');
    const chatModel = document.getElementById('chatModel');

    async function sendChat() {
      const msg = chatInput.value.trim();
      if (!msg) return;

      const userDiv = document.createElement('div');
      userDiv.className = 'chat-message user';
      userDiv.innerHTML = `<strong style="color:var(--text);">You</strong><br/><span style="font-size:12px;">${msg}</span>`;
      chatLog.appendChild(userDiv);
      chatInput.value = '';
      chatOut.innerHTML = '<div class="loading" style="font-size:12px;">ChatBot processing your query...</div>';
      chatLog.scrollTop = chatLog.scrollHeight;

      try {
        const resp = await fetch(`${apiBase}/code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query: msg,
            provider: chatProvider.value || 'google',
            model: chatModel.value.trim() || 'gemini-2.5-flash',
            retrieve_k: 50,
            rerank_k: 5,
            kb_path: 'c:/MY PROJECTS/GEN AI/working_modules/module_1_data_kb/output/kb.json',
            index_path: 'c:/MY PROJECTS/GEN AI/working_modules/output/faiss.index',
            metadata_path: 'c:/MY PROJECTS/GEN AI/working_modules/output/item_metadata.json'
          })
        });

        if (!resp.ok) throw new Error(`API error ${resp.status}`);
        const data = await resp.json();

        // Safely extract codes and format them
        const codesArray = data.grounded?.codes || [];
        const codes = Array.isArray(codesArray) ? codesArray.join(', ') : String(codesArray || 'N/A');
        const confidence = data.grounded?.confidence || 0;
        const explanation = data.grounded?.explanation || 'No response generated';
        const modelUsed = data.grounded?.model || 'n/a';
        const elapsed = data.grounded?.elapsed_ms || 0;
        
        // Format the response
        chatOut.innerHTML = `
          <div style="margin-bottom:10px; padding:10px; background:rgba(34, 211, 238, .1); border-radius:8px;">
            <strong style="color:var(--accent);">Recommended Codes:</strong><br/>
            <span style="font-size:13px; color:var(--text); font-weight:600;">${codes || 'No codes identified'}</span>
          </div>
          <div style="margin-bottom:10px; padding:10px; background:rgba(16, 185, 129, .1); border-radius:8px;">
            <strong style="color:var(--success);">Confidence:</strong> <span style="font-size:13px; color:var(--success); font-weight:700;">${confidence}%</span>
          </div>
          <div style="margin-bottom:10px; padding:10px; background:rgba(167, 139, 250, .1); border-radius:8px;">
            <strong style="color:var(--accent-2);">Model:</strong> <span style="font-size:13px; color:var(--text);">${modelUsed}</span> <span style="color:var(--muted);">(${elapsed.toFixed ? elapsed.toFixed(0) : elapsed} ms)</span>
          </div>
          <div style="margin-top:12px; padding:12px; background:rgba(20, 27, 45, .5); border-radius:8px; line-height:1.6; font-size:12px;">
            <strong style="color:var(--accent);">Clinical Analysis:</strong><br/>
            ${explanation}
          </div>
        `;

        const botDiv = document.createElement('div');
        botDiv.className = 'chat-message bot';
        botDiv.innerHTML = `<strong style="color:var(--accent);">Assistant</strong><br/><span style="font-size:11px;">${codes ? 'Codes: ' + codes + ' | Confidence: ' + confidence + '%' : 'No codes identified'}</span>`;
        chatLog.appendChild(botDiv);
        chatLog.scrollTop = chatLog.scrollHeight;

      } catch (err) {
        console.error('ChatBot error:', err);
        chatOut.innerHTML = `<div style="color:var(--danger); font-size:12px;">‚ö†Ô∏è Error: ${err.message}</div>`;
        const errDiv = document.createElement('div');
        errDiv.className = 'chat-message bot';
        errDiv.innerHTML = `<strong style="color:var(--danger);">Error</strong><br/><span style="font-size:11px;">Failed to process request. Please try again.</span>`;
        chatLog.appendChild(errDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
      }
    }

    btnChat.addEventListener('click', sendChat);
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });
  </script>
</body>
</html>
